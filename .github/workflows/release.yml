name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build release binary
        run: |
          cd MonitorKeyboardFix
          swift build -c release --arch arm64

      - name: Create .app bundle
        run: make app-bundle

      - name: Package artifacts
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          cd "MonitorKeyboardFix/.build"
          tar -czf "MonitorKeyboardFix-${VERSION}-macOS-arm64.tar.gz" "Monitor Keyboard Fix.app"
          cd ../..

          cp MonitorKeyboardFix/.build/release/MonitorKeyboardFix "monitor-keyboard-fix"
          tar -czf "MonitorKeyboardFix-${VERSION}-binary-arm64.tar.gz" monitor-keyboard-fix
          rm monitor-keyboard-fix

      - name: Compute SHA256
        id: sha
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APP_SHA=$(shasum -a 256 "MonitorKeyboardFix/.build/MonitorKeyboardFix-${VERSION}-macOS-arm64.tar.gz" | cut -d ' ' -f 1)
          BIN_SHA=$(shasum -a 256 "MonitorKeyboardFix-${VERSION}-binary-arm64.tar.gz" | cut -d ' ' -f 1)
          echo "app_sha=${APP_SHA}" >> $GITHUB_OUTPUT
          echo "bin_sha=${BIN_SHA}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            MonitorKeyboardFix/.build/MonitorKeyboardFix-*-macOS-arm64.tar.gz
            MonitorKeyboardFix-*-binary-arm64.tar.gz
          body: |
            ## Install

            ### Homebrew
            ```bash
            brew tap shyamalschandra/monitor-keyboard-fix https://github.com/shyamalschandra/Monitor-Keyboard-Fix.git
            brew install monitor-keyboard-fix
            ```

            ### Manual (.app)
            Download `MonitorKeyboardFix-*-macOS-arm64.tar.gz`, extract, and move `Monitor Keyboard Fix.app` to `/Applications`.

            ### Manual (binary)
            Download `MonitorKeyboardFix-*-binary-arm64.tar.gz`, extract, and place `monitor-keyboard-fix` in your `$PATH`.

            ## SHA256 Checksums
            - App Bundle: `${{ steps.sha.outputs.app_sha }}`
            - Binary: `${{ steps.sha.outputs.bin_sha }}`

      - name: Update Homebrew formula
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          TAG=${GITHUB_REF_NAME}
          FORMULA="Formula/monitor-keyboard-fix.rb"

          # Wait briefly for GitHub to make the source tarball available
          sleep 10

          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz"
          SHA256=$(curl -sL "$URL" | shasum -a 256 | cut -d ' ' -f 1)

          if [[ -z "$SHA256" || "$SHA256" == "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" ]]; then
            echo "WARNING: Could not compute source SHA256. Skipping formula update."
            exit 0
          fi

          echo "Source SHA256: $SHA256"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git reset --hard origin/main

          sed -i '' "s|archive/refs/tags/v[^\"]*\.tar\.gz|archive/refs/tags/${TAG}.tar.gz|" "$FORMULA"
          sed -i '' "s|sha256 \"[^\"]*\"|sha256 \"${SHA256}\"|" "$FORMULA"

          git add "$FORMULA"
          git diff --staged --quiet && echo "No formula changes" || git commit -m "Update Homebrew formula for ${TAG}"
          git push origin main
