name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Build release binary
        run: |
          cd MonitorKeyboardFix
          swift build -c release --arch arm64

      - name: Create .app bundle
        run: make app-bundle

      - name: Package artifacts
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          # .app bundle tarball
          cd "MonitorKeyboardFix/.build"
          tar -czf "MonitorKeyboardFix-${VERSION}-macOS-arm64.tar.gz" "Monitor Keyboard Fix.app"
          cd ../..

          # Standalone binary
          cp MonitorKeyboardFix/.build/release/MonitorKeyboardFix "monitor-keyboard-fix"
          tar -czf "MonitorKeyboardFix-${VERSION}-binary-arm64.tar.gz" monitor-keyboard-fix
          rm monitor-keyboard-fix

      - name: Compute SHA256
        id: sha
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SOURCE_SHA=$(shasum -a 256 <(curl -sL "https://github.com/${{ github.repository }}/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz") | cut -d ' ' -f 1)
          APP_SHA=$(shasum -a 256 "MonitorKeyboardFix/.build/MonitorKeyboardFix-${VERSION}-macOS-arm64.tar.gz" | cut -d ' ' -f 1)
          BIN_SHA=$(shasum -a 256 "MonitorKeyboardFix-${VERSION}-binary-arm64.tar.gz" | cut -d ' ' -f 1)
          echo "source_sha=${SOURCE_SHA}" >> $GITHUB_OUTPUT
          echo "app_sha=${APP_SHA}" >> $GITHUB_OUTPUT
          echo "bin_sha=${BIN_SHA}" >> $GITHUB_OUTPUT
          echo "Source SHA256: ${SOURCE_SHA}"
          echo "App SHA256: ${APP_SHA}"
          echo "Binary SHA256: ${BIN_SHA}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            MonitorKeyboardFix/.build/MonitorKeyboardFix-*-macOS-arm64.tar.gz
            MonitorKeyboardFix-*-binary-arm64.tar.gz
          body: |
            ## Install

            ### Homebrew
            ```bash
            brew tap shyamalschandra/monitor-keyboard-fix
            brew install monitor-keyboard-fix
            ```

            ### Manual (.app)
            Download `MonitorKeyboardFix-*-macOS-arm64.tar.gz`, extract, and move `Monitor Keyboard Fix.app` to `/Applications`.

            ### Manual (binary)
            Download `MonitorKeyboardFix-*-binary-arm64.tar.gz`, extract, and place `monitor-keyboard-fix` in your `$PATH`.

            ## SHA256 Checksums
            - Source: `${{ steps.sha.outputs.source_sha }}`
            - App Bundle: `${{ steps.sha.outputs.app_sha }}`
            - Binary: `${{ steps.sha.outputs.bin_sha }}`
